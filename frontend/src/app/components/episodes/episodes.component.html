<section class="episodes-container">

  <!-- ========================= -->
  <!-- TÍTULO -->
  <!-- ========================= -->
  <h2>
    Episodios (página {{ page() }} de {{ totalPages() }})
  </h2>

  <!-- ========================= -->
  <!-- FILTROS DE BÚSQUEDA -->
  <!-- ========================= -->
  <div class="filters">

    <input
      type="text"
      placeholder="Buscar por nombre del episodio"
      [disabled]="loading()"
      [ngModel]="filterName()"
      (ngModelChange)="filterName.set($event)"
    />

    <select
      [disabled]="loading()"
      [ngModel]="filterSeason()"
      (ngModelChange)="filterSeason.set($event)">
      <option *ngFor="let s of seasons" [value]="s.value">
        {{ s.label }}
      </option>
    </select>

    <input
      type="text"
      placeholder="Buscar por fecha de emisión"
      [disabled]="loading()"
      [ngModel]="filterAirDate()"
      (ngModelChange)="filterAirDate.set($event)"
    />

    <input
      type="text"
      placeholder="Buscar por personaje"
      [disabled]="loading()"
      [ngModel]="filterCharacter()"
      (ngModelChange)="filterCharacter.set($event)"
    />
  </div>

  <!-- ACCIONES -->
  <div class="filters-actions">
    <button
      type="button"
      (click)="limpiarFiltros()"
      [disabled]="loading()">
      Limpiar filtros
    </button>
  </div>

  <!-- ========================= -->
  <!-- BLOQUES MODERNOS ANGULAR -->
  <!-- ========================= -->

  @defer {

    <!-- ERROR -->
    @if (error()) {
      <app-error [mensaje]="error()"></app-error>
    }

    <!-- SIN RESULTADOS -->
    @if (!error() && filteredEpisodes.length === 0) {
      <div class="no-results">
        No se encontraron episodios con los filtros aplicados.
      </div>
    }

    <!-- LISTA DE EPISODIOS -->
    @if (filteredEpisodes.length > 0) {
      <ul>

        @for (e of filteredEpisodes; track e.id) {
          <li class="episode-card">

            <h3>{{ e.name }}</h3>

            <p class="episode-info">
              {{ e.episode }} — {{ formatFecha(e.airDate) }}
            </p>

            <!-- PERSONAJES -->
            @if (e.characters?.length) {
              <div class="characters-container">
                <h4>Personajes</h4>

                <div class="characters-grid">
                  @for (c of e.characters; track c.id) {
                    <div class="character-card">
                      <img [src]="c.image" [alt]="c.name" />
                      <span>{{ c.name }}</span>
                    </div>
                  }
                </div>
              </div>
            }

          </li>
        }

      </ul>
    }

    <!-- PAGINACIÓN -->
    <div class="pagination">
      <button
        (click)="prev()"
        [disabled]="page() <= 1 || loading()">
        Anterior
      </button>

      <button
        (click)="next()"
        [disabled]="page() >= totalPages() || loading()">
        Siguiente
      </button>
    </div>

  }
  @loading {
    <!-- Estado de carga usando defer -->
    <div class="loading">
      Cargando episodios...
    </div>
  }
  @error {
    <!-- Error inesperado durante el render -->
    <app-error mensaje="Error inesperado al cargar la vista"></app-error>
  }

</section>
